<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPHA STUDIO | PAINEL NEURAL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@700&family=Inter:wght@300;400;600;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { 
            --black: #050505; 
            --dark-gray: #0d0d0d; 
            --card-bg: rgba(15, 15, 15, 0.8); 
            --lime: #CCFF00; 
            --lime-glow: rgba(204, 255, 0, 0.3);
            --white: #fff; 
            --gray: #666; 
            --danger: #ff0055; 
            --border: rgba(255, 255, 255, 0.05);
            --radius: 24px;
            --radius-sm: 14px;
            --bezier: cubic-bezier(0.19, 1, 0.22, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { 
            background: var(--black); 
            color: var(--white); 
            display: flex; 
            min-height: 100vh; 
            background-image: radial-gradient(circle at 2px 2px, rgba(204, 255, 0, 0.05) 1px, transparent 0);
            background-size: 40px 40px;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--black); }
        ::-webkit-scrollbar-thumb { background: var(--lime); border-radius: 10px; box-shadow: 0 0 10px var(--lime); }

        @keyframes reveal {
            from { opacity: 0; transform: translateY(20px); filter: blur(10px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        #login-overlay { 
            position: fixed; inset: 0; background: var(--black); z-index: 9999; 
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            backdrop-filter: blur(20px);
        }
        .login-box { 
            background: var(--dark-gray); padding: 50px; border-radius: var(--radius); 
            border: 1px solid var(--border); width: 90%; max-width: 400px; 
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: reveal 0.8s var(--bezier);
        }

        aside { 
            width: 280px; background: rgba(5, 5, 5, 0.95); 
            border: 1px solid var(--border); display: flex; flex-direction: column; 
            padding: 40px 20px; position: fixed; height: calc(100vh - 40px); z-index: 100;
            backdrop-filter: blur(15px); margin: 20px; border-radius: var(--radius);
        }
        .logo { 
            font-family: 'Syncopate'; font-size: 1.2rem; margin-bottom: 60px; 
            text-decoration: none; color: var(--white); letter-spacing: 4px; text-align: center;
        }
        .logo span { color: var(--lime); text-shadow: 0 0 15px var(--lime); }
        
        .nav-link { 
            color: var(--gray); text-decoration: none; display: flex; align-items: center; 
            padding: 15px; border-radius: var(--radius-sm); transition: 0.4s var(--bezier); cursor: pointer; 
            font-size: 0.8rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
            margin-bottom: 10px;
        }
        .nav-link i { margin-right: 15px; font-size: 1.1rem; }
        .nav-link:hover, .nav-link.active { 
            background: var(--lime); color: var(--black); 
            transform: scale(1.05); box-shadow: 0 10px 20px var(--lime-glow);
        }

        main { margin-left: 320px; width: calc(100% - 320px); padding: 50px; display: none; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 50px; padding-bottom: 20px; border-bottom: 1px solid var(--border);
            animation: reveal 0.6s var(--bezier);
        }
        h2 { font-family: 'Syncopate'; font-size: 1.4rem; letter-spacing: 2px; color: var(--white); }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 40px; }
        .stat-card { 
            background: var(--card-bg); padding: 30px; border-radius: var(--radius); 
            border: 1px solid var(--border); position: relative; overflow: hidden;
            transition: 0.4s var(--bezier); animation: reveal 0.8s var(--bezier) backwards;
        }
        .stat-card:hover { border-color: var(--lime); transform: translateY(-10px) scale(1.02); }
        .stat-card h3 { font-size: 0.65rem; color: var(--gray); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .stat-card .value { font-size: 2.8rem; font-weight: 900; color: var(--lime); font-family: 'JetBrains Mono'; text-shadow: 0 0 20px var(--lime-glow); }

        .charts-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 25px; margin-bottom: 40px; }
        .chart-container { 
            background: var(--card-bg); padding: 25px; border: 1px solid var(--border); 
            border-radius: var(--radius); height: 400px; animation: reveal 1s var(--bezier) 0.4s backwards;
        }

        .glass-box { 
            background: var(--card-bg); padding: 35px; border-radius: var(--radius); 
            border: 1px solid var(--border); margin-bottom: 40px;
            backdrop-filter: blur(10px); animation: reveal 0.8s var(--bezier);
        }
        
        label { font-family: 'JetBrains Mono'; font-size: 0.65rem; color: var(--lime); margin-top: 20px; display: block; opacity: 0.8; }
        
        input { 
            background: rgba(0,0,0,0.5); border: 1px solid var(--border); padding: 16px; 
            color: white; width: 100%; border-radius: var(--radius-sm); margin-top: 8px; font-family: 'JetBrains Mono';
            transition: 0.3s var(--bezier);
        }
        input:focus { border-color: var(--lime); background: rgba(204, 255, 0, 0.05); outline: none; padding-left: 25px; }
        
        button { 
            background: var(--lime); color: var(--black); border: none; padding: 18px 35px; 
            font-weight: 900; cursor: pointer; margin-top: 25px; letter-spacing: 2px; 
            text-transform: uppercase; font-size: 0.75rem; transition: 0.4s var(--bezier);
            border-radius: 50px;
        }
        button:hover { background: var(--white); transform: scale(1.05) skewX(-5deg); box-shadow: 0 0 30px rgba(255,255,255,0.2); }

        #preview-area { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 20px; 
            margin-top: 30px; 
        }
        .preview-item { 
            background: rgba(255,255,255,0.03); 
            border: 1px solid var(--border); 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            border-radius: var(--radius-sm);
            animation: reveal 0.5s var(--bezier) backwards; 
            position: relative;
            transition: 0.3s;
        }
        .preview-item:hover { border-color: var(--lime); background: rgba(204, 255, 0, 0.02); }
        .preview-item img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; }
        
        .remove-file {
            position: absolute; top: -10px; right: -10px; width: 28px; height: 28px;
            background: var(--danger); color: white; border: none; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
            cursor: pointer; z-index: 10; padding: 0; box-shadow: 0 4px 15px rgba(255, 0, 85, 0.4);
            transition: 0.3s var(--bezier);
        }

        .work-card { 
            display: flex; align-items: center; background: rgba(255,255,255,0.02); 
            padding: 20px; border: 1px solid var(--border); margin-bottom: 15px;
            transition: 0.4s var(--bezier); border-radius: var(--radius-sm);
        }
        .work-card:hover { background: rgba(204,255,0,0.03); border-color: var(--lime); transform: translateX(15px); }
        .work-card .thumb { 
            width: 100px; height: 60px; object-fit: cover; margin-right: 25px; 
            border-radius: 12px; transition: 0.3s;
        }

        .btn-action-cyber { 
            font-family: 'JetBrains Mono'; font-size: 0.65rem; 
            border: 1px solid var(--gray); padding: 8px 18px; cursor: pointer; 
            background: transparent; transition: 0.3s; border-radius: 50px;
            color: var(--gray); margin-right: 5px;
        }
        .btn-approve { border-color: var(--lime); color: var(--lime); }
        .btn-approve.active { background: var(--lime); color: var(--black); }
        .btn-del { border-color: var(--danger); color: var(--danger); }
        .btn-del:hover { background: var(--danger); color: var(--white); }

        .featured-editor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .featured-item-box {
            background: rgba(255,255,255,0.02);
            padding: 25px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            position: relative;
            transition: 0.3s;
        }
        .featured-item-box.active-slot { border-color: var(--lime); background: rgba(204, 255, 0, 0.02); }
        
        .slot-indicator {
            position: absolute; top: 15px; right: 15px; font-size: 0.5rem;
            font-family: 'JetBrains Mono'; color: var(--gray); letter-spacing: 1px;
        }

        .btn-clear-slot {
            background: transparent; border: 1px solid var(--danger); color: var(--danger);
            padding: 5px 12px; font-size: 0.55rem; border-radius: 50px; margin-top: 15px;
            width: fit-content; cursor: pointer; transition: 0.3s;
        }
        .btn-clear-slot:hover { background: var(--danger); color: white; }

        .table-container { border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; background: var(--card-bg); }
        th { text-align: left; padding: 20px; color: var(--lime); font-family: 'JetBrains Mono'; font-size: 0.7rem; background: rgba(255,255,255,0.02); }
        td { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.02); font-size: 0.85rem; color: #ccc; }

        .content-section { display: none; }
        .active-section { display: block; animation: reveal 0.6s var(--bezier); }

        /* MOBILE RESPONSIVENESS */
        .mobile-menu-btn { display: none; background: transparent; border: 1px solid var(--lime); color: var(--lime); padding: 10px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; }

        @media (max-width: 768px) {
            body { display: block; overflow-x: hidden; }
            
            aside { 
                transform: translateX(-110%); 
                width: 85%; 
                height: 100vh; 
                margin: 0; 
                top: 0; left: 0;
                box-shadow: 10px 0 30px rgba(0,0,0,0.8);
                transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            }
            aside.mobile-active { transform: translateX(0); }
            
            main { margin-left: 0; width: 100%; padding: 20px; padding-top: 80px; }
            
            header { 
                position: fixed; top: 0; left: 0; width: 100%; 
                background: rgba(5,6,6,0.9); backdrop-filter: blur(15px);
                z-index: 90; padding: 15px 20px; margin: 0; border-bottom: 1px solid var(--border);
            }
            header h2 { font-size: 0.9rem; }
            
            .mobile-menu-btn { display: block; position: fixed; top: 15px; right: 20px; z-index: 101; }
            
            /* Hide the sync button on header to save space or move it */
            #btn-manual-refresh { display: none; } 

            .stats-grid { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            
            .featured-editor-grid { grid-template-columns: 1fr; }
            
            .login-box { padding: 30px; width: 95%; }
            
            table, thead, tbody, th, td, tr { display: block; }
            th { display: none; }
            td { 
                position: relative; padding-left: 50%; 
                border: none; border-bottom: 1px solid #222; 
            }
            td:before { 
                content: attr(data-label); /* Requires data-label attr to work perfectly, or just stacking */
                position: absolute; left: 10px; color: var(--lime); font-size: 0.7rem; font-weight: bold;
            }
            /* Simplified table for now - just stack content */
            td { padding-left: 10px; text-align: right; display: flex; justify-content: space-between; align-items: center; }
            td span { text-align: right; }
        }
    </style>
</head>
<body onload="initApp()">

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color: var(--lime); margin-bottom: 30px; font-family: 'Syncopate';">AUTENTICAÇÃO</h2>
            <input type="email" id="login-email" placeholder="IDENTIFICAÇÃO_USUÁRIO">
            <input type="password" id="login-pass" placeholder="CHAVE_SEGURANÇA">
            <button id="btn-login" style="width: 100%;">ACESSAR_PAINEL</button>
        </div>
    </div>

    <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>

    <aside id="sidebar" style="display: none;">
        <a href="#" class="logo">ALPHA<span>STUDIO</span></a>
        <ul class="nav-menu" style="list-style: none;">
            <li class="nav-item"><div class="nav-link active" onclick="showSection('dashboard', this)"><i class="fas fa-terminal"></i> Início Dashboard</div></li>
            <li class="nav-item"><div class="nav-link" onclick="showSection('galeria', this)"><i class="fas fa-folder-open"></i> Galeria Studio</div></li>
            <li class="nav-item"><div class="nav-link" onclick="showSection('clientes', this)"><i class="fas fa-user-shield"></i> Leads Alpha</div></li>
            <li class="nav-item"><div class="nav-link" onclick="showSection('configuracoes', this)"><i class="fas fa-microchip"></i> Configurações</div></li>
            <li class="nav-item"><div class="nav-link" id="btn-logout" style="color: var(--danger); margin-top: 50px;"><i class="fas fa-power-off"></i> Sair do Sistema</div></li>
        </ul>
    </aside>

    <main id="main-content">
        <section id="dashboard" class="content-section active-section">
            <header>
                <h2>VISÃO_GERAL_ALPHA</h2>
                <button class="btn-action-cyber btn-approve" id="btn-manual-refresh" style="margin-top: 0; padding: 10px 22px;">
                    <i class="fas fa-sync-alt"></i> SINCRONIZAR_SISTEMA
                </button>
            </header>
            <div class="stats-grid">
                <div class="stat-card"><h3>TOTAL_ACESSOS</h3><div class="value" id="stat-visits">0</div></div>
                <div class="stat-card"><h3>OBRAS_ATIVAS</h3><div class="value" id="stat-works">0</div></div>
                <div class="stat-card"><h3>TOTAL_INSCRITOS</h3><div class="value" id="stat-clients">0</div></div>
            </div>
            <div class="charts-grid">
                <div class="chart-container"><canvas id="barChart"></canvas></div>
                <div class="chart-container"><canvas id="pieChart"></canvas></div>
            </div>
        </section>

        <section id="galeria" class="content-section">
            <header><h2>GERENCIAR_GALERIA_E_DESTAQUES</h2></header>
            
            <div class="glass-box">
                <h3 style="font-size: 0.7rem; color: var(--lime); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 25px;">Curadoria de Destaques (Main Home)</h3>
                <div class="featured-editor-grid">
                    <div class="featured-item-box" id="slot-1">
                        <span class="slot-indicator">SLOT_01</span>
                        <label>TÍTULO PRINCIPAL</label><input type="text" id="feat-t1">
                        <label>DESCRIÇÃO CURTA</label><input type="text" id="feat-d1">
                        <label>SUBSTITUIR IMAGEM</label><input type="file" id="feat-f1" accept="image/*">
                        <button class="btn-clear-slot" onclick="clearFeaturedSlot(1)">LIMPAR_SLOT</button>
                    </div>
                    <div class="featured-item-box" id="slot-2">
                        <span class="slot-indicator">SLOT_02</span>
                        <label>TÍTULO PRINCIPAL</label><input type="text" id="feat-t2">
                        <label>DESCRIÇÃO CURTA</label><input type="text" id="feat-d2">
                        <label>SUBSTITUIR IMAGEM</label><input type="file" id="feat-f2" accept="image/*">
                        <button class="btn-clear-slot" onclick="clearFeaturedSlot(2)">LIMPAR_SLOT</button>
                    </div>
                    <div class="featured-item-box" id="slot-3">
                        <span class="slot-indicator">SLOT_03</span>
                        <label>TÍTULO PRINCIPAL</label><input type="text" id="feat-t3">
                        <label>DESCRIÇÃO CURTA</label><input type="text" id="feat-d3">
                        <label>SUBSTITUIR IMAGEM</label><input type="file" id="feat-f3" accept="image/*">
                        <button class="btn-clear-slot" onclick="clearFeaturedSlot(3)">LIMPAR_SLOT</button>
                    </div>
                </div>
                <button id="btn-update-home" style="width: 100%;">SINCRONIZAR CURADORIA COM SERVIDOR</button>
            </div>

            <div class="glass-box">
                <h3 style="font-size: 0.7rem; color: var(--lime); letter-spacing: 2px;">UPLOAD_MÚLTIPLO_GALERIA</h3>
                <label>ADICIONAR NOVAS OBRAS</label>
                <input type="file" id="work-file" accept="image/*" multiple style="border: 2px dashed var(--lime); padding: 30px; cursor: pointer; text-align: center; width: 100%;">
                <div id="preview-area"></div>
                <div id="upload-status" style="font-size: 0.7rem; margin-top: 15px; color: var(--lime); font-family: 'JetBrains Mono'; text-align: center;"></div>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button id="btn-publish" style="display:none; flex: 2; margin-top: 0;">PUBLICAR NA GALERIA</button>
                    <button id="btn-cancel-upload" style="display:none; flex: 1; background: var(--danger); color: white; margin-top: 0;">CANCELAR</button>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 1rem;">ATIVOS_DA_TIMELINE</h2>
                <button class="btn-action-cyber btn-del" onclick="deleteSelectedWorks()">DELETAR_SELECIONADOS</button>
            </div>
            <div id="works-container"></div>
        </section>

        <section id="clientes" class="content-section">
            <header><h2>GERENCIAR_MENSAGENS_E_LEADS</h2></header>
            <div class="table-container">
                <table>
                    <thead><tr><th>SUJEITO</th><th>LOCAL / CONTATO</th><th>MENSAGEM</th><th>MODERAÇÃO</th></tr></thead>
                    <tbody id="clients-list"></tbody>
                </table>
            </div>
        </section>

        <section id="configuracoes" class="content-section">
            <header><h2>PARÂMETROS_DO_CORE</h2></header>
            <div class="glass-box" style="max-width: 600px;">
                <label>LINK_INSTAGRAM</label><input type="text" id="cfg-instagram" placeholder="@alphastudio">
                <label>WHATSAPP_SEGURO</label><input type="text" id="cfg-phone" placeholder="+55 00 00000-0000">
                <label>E-MAIL_CRIPTOGRAFADO</label><input type="email" id="cfg-email" placeholder="contato@alphastudio.com">
                <button id="btn-save-settings">CONFIRMAR_ALTERAÇÕES</button>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, setDoc, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAO6azVpX988Vwu___-pp9c0oprqPThMlQ",
            authDomain: "matematica-em-foco.firebaseapp.com",
            projectId: "matematica-em-foco",
            storageBucket: "matematica-em-foco.firebasestorage.app",
            messagingSenderId: "1031540454030",
            appId: "1:1031540454030:web:f6a91af6171c1d6c694fdf",
            measurementId: "G-SS4FPBYQ5X"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let barChart, pieChart;
        let selectedFiles = [];

        // --- GESTÃO DE DESTAQUES (PRINCIPAIS CONTEÚDOS) ---
        
        window.toggleMobileMenu = () => {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('mobile-active');
            
            // Close menu if clicked on a link (optional UX improvement)
            if(sb.classList.contains('mobile-active')) {
                const links = sb.querySelectorAll('.nav-link');
                links.forEach(l => l.onclick = () => {
                    // Original showSection logic is kept via HTML inline onclick, just add close sidebar
                    // We need to preserve the original onclick.
                    // Actually, simpler: let's just make the sidebar close function wrapper.
                    sb.classList.remove('mobile-active');
                    const pageId = l.getAttribute('onclick').match(/'([^']+)'/)[1];
                    showSection(pageId, l);
                });
            }
        };
        
        window.clearFeaturedSlot = async (slot) => {
            if(!confirm(`Deseja limpar o Slot ${slot}?`)) return;
            try {
                await setDoc(doc(db, "featured", `slot${slot}`), { 
                    title: "", desc: "", img: "" 
                });
                loadFeaturedToInputs();
                alert(`Slot ${slot} resetado. Clique em Sincronizar para aplicar.`);
            } catch (e) {
                console.error("Erro ao limpar slot:", e);
                alert("Erro ao limpar slot.");
            }
        };

        async function loadFeaturedToInputs() {
            try {
                for(let i=1; i<=3; i++) {
                    const docSnap = await getDoc(doc(db, "featured", `slot${i}`));
                    const item = docSnap.exists() ? docSnap.data() : { title: "", desc: "", img: "" };
                    
                    const slotBox = document.getElementById(`slot-${i}`);
                    const t = document.getElementById(`feat-t${i}`);
                    const d = document.getElementById(`feat-d${i}`);
                    
                    t.value = item.title || "";
                    d.value = item.desc || "";
                    
                    // Verifica se existe algo setado e destaca o box
                    if(item.title || item.img) {
                        slotBox.classList.add('active-slot');
                    } else {
                        slotBox.classList.remove('active-slot');
                    }
                }
            } catch (e) {
                console.error("Erro ao carregar destaques:", e);
            }
        }

        document.getElementById('btn-update-home').addEventListener('click', async () => {
            const btn = document.getElementById('btn-update-home');
            btn.disabled = true; btn.innerText = "ATUALIZANDO SERVIDOR...";
            
            try {
                for (let i = 1; i <= 3; i++) {
                    const fileInput = document.getElementById(`feat-f${i}`);
                    const title = document.getElementById(`feat-t${i}`).value;
                    const desc = document.getElementById(`feat-d${i}`).value;
                    
                    // Recupera imagem atual do banco para não perder se não houver upload
                    const oldSnap = await getDoc(doc(db, "featured", `slot${i}`));
                    let imageUrl = oldSnap.exists() ? oldSnap.data().img : "";

                    if (fileInput.files[0]) {
                        const storageRef = ref(storage, `destaques/feat_${i}_${Date.now()}`);
                        await uploadBytes(storageRef, fileInput.files[0]);
                        imageUrl = await getDownloadURL(storageRef);
                    }
                    
                    await setDoc(doc(db, "featured", `slot${i}`), { 
                        title, desc, img: imageUrl 
                    });
                }
                alert("Curadoria atualizada com sucesso e sincronizada em tempo real!");
                loadFeaturedToInputs();
            } catch (e) {
                console.error(e);
                alert("Erro ao atualizar curadoria.");
            }
            
            btn.disabled = false; btn.innerText = "SINCRONIZAR CURADORIA COM SERVIDOR";
        });

        // --- LÓGICA DE GALERIA GERAL ---

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('sidebar').style.display = 'flex';
                document.getElementById('main-content').style.display = 'block';
                initCharts(); loadData(); loadFeaturedToInputs();
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('sidebar').style.display = 'none';
                document.getElementById('main-content').style.display = 'none';
            }
        });

        document.getElementById('work-file').addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            selectedFiles = [...selectedFiles, ...newFiles];
            updatePreviews();
        });

        function updatePreviews() {
            const previewArea = document.getElementById('preview-area');
            const btnPublish = document.getElementById('btn-publish');
            const btnCancel = document.getElementById('btn-cancel-upload');
            previewArea.innerHTML = '';
            
            if (selectedFiles.length > 0) {
                btnPublish.style.display = 'block'; btnCancel.style.display = 'block';
                selectedFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const item = document.createElement('div');
                        item.className = 'preview-item';
                        item.innerHTML = `
                            <button class="remove-file" onclick="removeFile(${index})"><i class="fas fa-times"></i></button>
                            <img src="${e.target.result}">
                            <input type="text" class="multi-title" placeholder="LEGENDA" data-index="${index}">
                        `;
                        previewArea.appendChild(item);
                    }
                    reader.readAsDataURL(file);
                });
            } else { 
                btnPublish.style.display = 'none'; btnCancel.style.display = 'none';
                document.getElementById('work-file').value = "";
            }
        }

        window.removeFile = (index) => {
            selectedFiles.splice(index, 1);
            updatePreviews();
        };

        document.getElementById('btn-cancel-upload').addEventListener('click', () => {
            selectedFiles = []; updatePreviews();
        });

        document.getElementById('btn-publish').addEventListener('click', async () => {
            const status = document.getElementById('upload-status');
            const btn = document.getElementById('btn-publish');
            btn.disabled = true;
            
            try {
                for (let i = 0; i < selectedFiles.length; i++) {
                    status.innerText = `UPLOADING: ${i+1}/${selectedFiles.length}...`;
                    const storageRef = ref(storage, `galeria/${Date.now()}_${selectedFiles[i].name}`);
                    await uploadBytes(storageRef, selectedFiles[i]);
                    const url = await getDownloadURL(storageRef);
                    const title = document.querySelector(`.multi-title[data-index="${i}"]`).value;
                    
                    await addDoc(collection(db, "gallery"), {
                        title: title || "OBRA_ALPHA",
                        url: url,
                        createdAt: Date.now()
                    });
                }
                
                status.innerText = "GALERIA ATUALIZADA NO CLOUD!";
                selectedFiles = [];
                setTimeout(() => { status.innerText = ""; }, 3000);
                updatePreviews();
                loadData();
            } catch (e) {
                console.error(e);
                status.innerText = "ERRO: " + e.message;
            }
            
            btn.disabled = false;
        });

        // --- UTILITÁRIOS MANTIDOS E DATA LOADING ---

        async function loadData() {
            try {
                // Carrega Galeria
                const worksQ = query(collection(db, "gallery"), orderBy("createdAt", "desc"));
                const worksSnap = await getDocs(worksQ);
                const works = [];
                worksSnap.forEach(doc => works.push({ id: doc.id, ...doc.data() }));

                // Carrega Leads
                const leadsQ = query(collection(db, "leads"), orderBy("data", "desc"));
                const leadsSnap = await getDocs(leadsQ);
                const leads = [];
                leadsSnap.forEach(doc => leads.push({ id: doc.id, ...doc.data() }));

                // Dashboard Stats
                const systemDoc = await getDoc(doc(db, "system", "stats"));
                const visits = systemDoc.exists() ? systemDoc.data().visits : 0;

                document.getElementById('stat-visits').innerText = visits;
                document.getElementById('stat-works').innerText = works.length;
                document.getElementById('stat-clients').innerText = leads.length;

                // Render Galeria List
                document.getElementById('works-container').innerHTML = works.map((w) => `
                    <div class="work-card">
                        <input type="checkbox" class="work-select" data-id="${w.id}" style="accent-color:var(--lime); margin-right:20px;">
                        <img src="${w.url}" class="thumb">
                        <div class="info">
                            <div style="font-family:'JetBrains Mono'; font-size:0.9rem;">${w.title}</div>
                            <div style="font-size:0.6rem; color:var(--gray);">ID: ${w.id}</div>
                        </div>
                    </div>
                `).join('');

                // Render Leads Table
                const clientsList = document.getElementById('clients-list');
                if(leads.length === 0) {
                    clientsList.innerHTML = '<tr><td colspan="4" style="text-align:center;">NENHUM LEAD ENCONTRADO</td></tr>';
                } else {
                    clientsList.innerHTML = leads.map(l => `
                        <tr>
                            <td>${l.nome}</td>
                            <td>${l.cidade}<br><span style="color:#555; font-size:0.7rem;">${l.tel}</span></td>
                            <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis;">${l.desc}</td>
                            <td>
                                <button onclick="toggleLeadDisplay('${l.id}', ${l.exibir})" style="padding:5px 10px; border-radius:4px; font-size:0.6rem; margin:0;" class="${l.exibir ? 'btn-approve active' : 'btn-action-cyber'}">
                                    ${l.exibir ? 'PUBLICADO' : 'OCULTO'}
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                if(pieChart) { pieChart.data.datasets[0].data = [works.length, leads.length]; pieChart.update(); }

            } catch (e) {
                console.error("Erro ao carregar dados:", e);
            }
        }

        window.toggleLeadDisplay = async (id, currentStatus) => {
            // Ensure boolean
            const statusBool = (currentStatus === true || currentStatus === "true");
            try {
                await setDoc(doc(db, "leads", id), { exibir: !statusBool }, { merge: true });
                loadData();
            } catch (e) {
                console.error("Erro ao alterar status:", e);
                alert("Erro ao atualizar status.");
            }
        };

        window.showSection = (id, element) => {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active-section'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active-section');
            element.classList.add('active');
        };

        function initCharts() {
            const ctxBar = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(ctxBar, { type: 'bar', data: { labels: ['SEG','TER','QUA','QUI','SEX','SAB','DOM'], datasets: [{label:'Tráfego', data:[40, 60, 80, 50, 90, 100, 70], backgroundColor:'#CCFF00', borderRadius: 10}] }, options: { responsive: true, maintainAspectRatio: false } });
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(ctxPie, { type: 'doughnut', data: { labels: ['Obras','Leads'], datasets: [{data:[0,0], backgroundColor:['#CCFF00','#1a1a1a'], borderWidth:0}] }, options: { cutout: '85%', responsive: true, maintainAspectRatio: false } });
        }

        document.getElementById('btn-login').addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            signInWithEmailAndPassword(auth, email, pass).catch(err => {
                alert("ACESSO_NEGADO: " + err.message);
            });
        });
        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));
        document.getElementById('btn-manual-refresh').addEventListener('click', () => loadData());
        
        window.deleteSelectedWorks = async () => {
            const selected = document.querySelectorAll('.work-select:checked');
            if(selected.length === 0) return;
            
            if(!confirm(`Deletar ${selected.length} item(s) permanentemente?`)) return;

            try {
                const deletePromises = Array.from(selected).map(chk => deleteDoc(doc(db, "gallery", chk.getAttribute('data-id'))));
                await Promise.all(deletePromises); // Parallel deletion
                alert("Itens deletados com sucesso.");
                loadData();
            } catch (e) {
                console.error(e);
                alert("Erro ao deletar itens.");
            }
        };
        
        document.getElementById('btn-save-settings').addEventListener('click', async () => {
            const config = {
                 insta: document.getElementById('cfg-instagram').value,
                 phone: document.getElementById('cfg-phone').value,
                 email: document.getElementById('cfg-email').value
            };
            try {
                await setDoc(doc(db, "system", "config"), config);
                alert("Configurações salvas na nuvem!");
            } catch(e) {
                console.error(e);
                alert("Erro ao salvar config.");
            }
        });

    </script>
</body>
</html>
<!-- root@J/A:~# -->
